<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/images/logo.png"><link rel="icon" href="/images/logo.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Jas0n0ss"><meta name="keywords" content="oss"><meta name="description" content="Ansible Detailed Tutorial II"><meta property="og:type" content="article"><meta property="og:title" content="Ansible Detailed Tutorial II"><meta property="og:url" content="https://git.msft.vip/2023/01/31-Ansible-Detailed-Tutorial-II/index.html"><meta property="og:site_name" content="git.msft.vip"><meta property="og:description" content="Ansible Detailed Tutorial II"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://git.msft.vip/images/1204916-20171208112235999-1825222840.png"><meta property="og:image" content="https://git.msft.vip/images/1204916-20171208112249906-1356198395.png"><meta property="og:image" content="https://git.msft.vip/images/1204916-20171208112258687-1002351873.png"><meta property="og:image" content="https://git.msft.vip/images/1204916-20171208112308109-1548774386.png"><meta property="og:image" content="https://git.msft.vip/images/1204916-20171208112328234-1706127649.png"><meta property="og:image" content="https://git.msft.vip/images/1204916-20171208112334765-1675703855.png"><meta property="og:image" content="https://git.msft.vip/images/1204916-20171208112345843-507673332.png"><meta property="og:image" content="https://git.msft.vip/images/1204916-20171208112356562-1275040347.png"><meta property="og:image" content="https://git.msft.vip/images/1204916-20171208112404531-432662099.png"><meta property="og:image" content="https://git.msft.vip/images/1204916-20171208112442234-829367844.png"><meta property="article:published_time" content="2023-01-31T09:57:43.000Z"><meta property="article:modified_time" content="2024-08-09T12:13:50.165Z"><meta property="article:author" content="Jas0n0ss"><meta property="article:tag" content="oss"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://git.msft.vip/images/1204916-20171208112235999-1825222840.png"><meta name="referrer" content="no-referrer-when-downgrade"><title>Ansible Detailed Tutorial II - git.msft.vip</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/custom_icon/other/iconfont.css"><link rel="stylesheet" href="/css/custom_icon/phone/iconfont.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"git.msft.vip",root:"/",version:"1.9.4",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Jas0n0ss</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-shouye"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives"><i class="iconfont icon-guidang"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/tags"><i class="iconfont icon-biaoqian"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/video"><i class="iconfont icon-youtube"></i> <span>视频</span></a></li><li class="nav-item"><a class="nav-link" href="/music"><i class="iconfont icon-tubiaozhizuomobanyihuifu-"></i> <span>音乐</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/code.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Ansible Detailed Tutorial II"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Jas0n0ss </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-01-31 17:57" pubdate>2023年1月31日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 12k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 97 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">Ansible Detailed Tutorial II</h1><p class="note note-info">本文最后更新于：2024年8月9日 晚上</p><div class="markdown-body"><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="400" height="86" src="//music.163.com/outchain/player?type=2&id=5113327&auto=1&height=66"></iframe>---<h2 id="Ansible-playbook-简介"><a href="#Ansible-playbook-简介" class="headerlink" title="Ansible playbook 简介"></a>Ansible playbook 简介</h2><p>　　<strong>playbook 是 ansible 用于配置，部署，和管理被控节点的剧本。</strong><br>　　通过 playbook 的详细描述，执行其中的一系列 tasks ，可以让远端主机达到预期的状态。playbook 就像 Ansible 控制器给被控节点列出的的一系列 to-do-list ，而被控节点必须要完成。<br>　　也可以这么理解，playbook 字面意思，即剧本，现实中由演员按照剧本表演，在Ansible中，这次由计算机进行表演，由计算机安装，部署应用，提供对外服务，以及组织计算机处理各种各样的事情。</p><h2 id="Ansible-playbook使用场景"><a href="#Ansible-playbook使用场景" class="headerlink" title="Ansible playbook使用场景"></a>Ansible playbook使用场景</h2><p>　　执行一些简单的任务，使用ad-hoc命令可以方便的解决问题，但是有时一个设施过于复杂，需要大量的操作时候，执行的ad-hoc命令是不适合的，这时最好使用playbook。<br>　　就像执行shell命令与写shell脚本一样，也可以理解为批处理任务，不过playbook有自己的语法格式。<br>　　使用playbook你可以方便的重用这些代码，可以移植到不同的机器上面，像函数一样，最大化的利用代码。在你使用Ansible的过程中，你也会发现，你所处理的大部分操作都是编写playbook。可以把常见的应用都编写成playbook，之后管理服务器会变得十分简单。</p><h2 id="Ansible-playbook格式"><a href="#Ansible-playbook格式" class="headerlink" title="Ansible playbook格式"></a>Ansible playbook格式</h2><h3 id="1）格式简介"><a href="#1）格式简介" class="headerlink" title="1）格式简介"></a>1）格式简介</h3><p>　　<strong>playbook由YMAL语言编写。</strong>YAML( &#x2F;ˈjæməl&#x2F; )参考了其他多种语言，包括：XML、C语言、Python、Perl以及电子邮件格式RFC2822，Clark Evans在2001年5月在首次发表了这种语言，另外Ingy döt Net与OrenBen-Kiki也是这语言的共同设计者。<br>　　YMAL格式是类似于JSON的文件格式，便于人理解和阅读，同时便于书写。首先学习了解一下YMAL的格式，对我们后面书写playbook很有帮助。以下为playbook常用到的YMAL格式：<br>　　1、文件的第一行应该以 “—“ (三个连字符)开始，表明YMAL文件的开始。<br>　　2、在同一行中，#之后的内容表示注释，类似于shell，python和ruby。<br>　　3、YMAL中的列表元素以”-”开头然后紧跟着一个空格，后面为元素内容。<br>　　4、同一个列表中的元素应该保持相同的缩进。否则会被当做错误处理。<br>　　5、play中hosts，variables，roles，tasks等对象的表示方法都是键值中间以”:”分隔表示，”:”后面还要增加一个空格。<br>　　下面是一个举例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-comment">#安装与运行mysql服务</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">node1</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">mysql-server</span> <span class="hljs-string">package</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=mysql-server</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">starting</span> <span class="hljs-string">mysqld</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=mysql</span> <span class="hljs-string">state=started</span><br></code></pre></td></tr></table></figure><p>　　我们的文件名称应该以<code>.yml</code>结尾，像我们上面的例子就是<code>mysql.yml</code>。其中，有三个部分组成：</p><blockquote><p><code>host部分</code>：使用 hosts 指示使用哪个主机或主机组来运行下面的 tasks ，每个 playbook 都必须指定 hosts ，hosts也<strong>可以使用通配符格式</strong>。主机或主机组在 inventory 清单中指定，可以使用系统默认的<code>/etc/ansible/hosts</code>，也可以自己编辑，在运行的时候加上<code>-i</code>选项，指定清单的位置即可。在运行清单文件的时候，<code>–list-hosts</code>选项会显示那些主机将会参与执行 task 的过程中。<br><code>remote_user</code>：指定远端主机中的哪个用户来登录远端系统，在远端系统执行 task 的用户，可以任意指定，也可以使用 sudo，但是用户必须要有执行相应 task 的权限。<br><code>tasks</code>：指定远端主机将要执行的一系列动作。tasks 的核心为 ansible 的模块，前面已经提到模块的用法。tasks 包含 <code>name</code> 和<code>要执行的模块</code>，name 是可选的，只是为了便于用户阅读，不过还是建议加上去，模块是必须的，同时也要给予模块相应的参数。</p></blockquote><p>　　使用ansible-playbook运行playbook文件，得到如下输出信息，输出内容为JSON格式。并且由不同颜色组成，便于识别。一般而言<br>| 绿色代表执行成功，系统保持原样<br>| 黄色代表系统代表系统状态发生改变<br>| 红色代表执行失败，显示错误输出<br>　　执行有三个步骤：1、收集facts 2、执行tasks 3、报告结果<br><img src="/../images/1204916-20171208112235999-1825222840.png" srcset="/img/loading.gif" lazyload alt="img"></p><h3 id="2）核心元素"><a href="#2）核心元素" class="headerlink" title="2）核心元素"></a>2）核心元素</h3><p>　　Playbook的核心元素：</p><ul><li><code>Hosts</code>：主机组；</li><li><code>Tasks</code>：任务列表</li><li><code>Variables</code>：变量，设置方式有四种；</li><li><code>Templates</code>：包含了模板语法的文本文件；</li><li><code>Handlers</code>：由特定条件触发的任务</li></ul><h3 id="3）基本组件"><a href="#3）基本组件" class="headerlink" title="3）基本组件"></a>3）基本组件</h3><p>Playbooks配置文件的基础组件：</p><p><code>Hosts</code>：运行指定任务的目标主机<br><code>remoute_user</code>：在远程主机上执行任务的用户；<br><code>sudo_user</code>：<br><code>tasks</code>：任务列表</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 格式：</span><br>　　　　<span class="hljs-string">tasks：</span><br>　　　　　　<span class="hljs-string">–</span> <span class="hljs-attr">name:</span> <span class="hljs-string">TASK_NAME</span><br>　　　　　　 <span class="hljs-attr">module:</span> <span class="hljs-string">arguments</span><br>　　　　　　 <span class="hljs-attr">notify:</span> <span class="hljs-string">HANDLER_NAME</span><br>　　　　　　 <span class="hljs-attr">handlers:</span><br>　　　　　　<span class="hljs-string">–</span> <span class="hljs-attr">name:</span> <span class="hljs-string">HANDLER_NAME</span><br>　　　　　　 <span class="hljs-attr">module:</span> <span class="hljs-string">arguments</span><br></code></pre></td></tr></table></figure><p><code>模块</code>，模块参数,格式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">action: module arguments<br>module: arguments<br><span class="hljs-comment"># 注意：shell和command模块后面直接跟命令，而非key=value类的参数列表　　</span><br></code></pre></td></tr></table></figure><p><code>handlers</code>：任务，在特定条件下触发；接收到其它任务的通知时被触发；</p><ul><li>某任务的状态在运行后为changed时，可通过“notify”通知给相应的handlers；</li><li>任务可以通过“tags“打标签，而后可在ansible-playbook命令上使用-t指定进行调用；</li></ul><h4 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h4><p><strong>① 定义playbook</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@server</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># cd /etc/ansible</span><br>[<span class="hljs-string">root@server</span> <span class="hljs-string">ansible</span>]<span class="hljs-comment"># vim nginx.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">web</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=present</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">nginx.conf</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=/tmp/nginx.conf</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span> <span class="hljs-string">backup=yes</span><br>      <span class="hljs-attr">notify:</span> <span class="hljs-string">reload</span>　　　　<span class="hljs-comment">#当nginx.conf发生改变时，通知给相应的handlers</span><br>      <span class="hljs-attr">tags:</span> <span class="hljs-string">reloadnginx</span>　　　<span class="hljs-comment">#打标签</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">nginx</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=started</span><br>      <span class="hljs-attr">tags:</span> <span class="hljs-string">startnginx</span>　　　<span class="hljs-comment">#打标签</span><br><br>  <span class="hljs-string">handlers:</span>　　<span class="hljs-comment">#注意，前面没有-，是两个空格</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">reload</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=restarted</span>　　<span class="hljs-comment">#为了在进程中能看出来</span><br></code></pre></td></tr></table></figure><p><strong>② 测试运行结果</strong><br>　　写完了以后，我们就可以运行了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@server ansible]<span class="hljs-comment"># ansible-playbook nginx.yml</span><br></code></pre></td></tr></table></figure><p><img src="/../images/1204916-20171208112249906-1356198395.png" srcset="/img/loading.gif" lazyload alt="img"><br>　　现在我们可以看看两台机器的端口是否开启：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@server ansible]<span class="hljs-comment"># ansible web -m shell -a &#x27;ss -nutlp |grep nginx&#x27;</span><br>192.168.37.122 | SUCCESS | rc=0 &gt;&gt;<br>tcp    LISTEN     0      128       *:80                    *:*                   <span class="hljs-built_in">users</span>:((&quot;nginx&quot;,pid=<span class="hljs-number">8304</span>,fd=<span class="hljs-number">6</span>),(&quot;nginx&quot;,pid=<span class="hljs-number">8303</span>,fd=<span class="hljs-number">6</span>))<br><br>192.168.37.133 | SUCCESS | rc=0 &gt;&gt;<br>tcp    LISTEN     0      128       *:80                    *:*                   <span class="hljs-built_in">users</span>:((&quot;nginx&quot;,pid=<span class="hljs-number">9671</span>,fd=<span class="hljs-number">6</span>),(&quot;nginx&quot;,pid=<span class="hljs-number">9670</span>,fd=<span class="hljs-number">6</span>))<br></code></pre></td></tr></table></figure><p><strong>③ 测试标签</strong><br>　　我们在里面已经打上了一个标签，所以可以直接引用标签。但是我们需要先把服务关闭，再来运行剧本并引用标签：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@server ansible]<span class="hljs-comment"># ansible web -m shell -a &#x27;systemctl stop nginx&#x27;</span><br>[root@server ansible]<span class="hljs-comment"># ansible-playbook nginx.yml -t startnginx</span><br></code></pre></td></tr></table></figure><p><img src="/../images/1204916-20171208112258687-1002351873.png" srcset="/img/loading.gif" lazyload alt="img"><br><strong>④ 测试notify</strong><br>　　我们还做了一个<code>notify</code>，来测试一下：<br>　　首先，它的触发条件是配置文件被改变，所以我们去把配置文件中的端口改一下：</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root@server ansible]<span class="hljs-comment"># vim /tmp/nginx.conf</span><br>	<span class="hljs-keyword">listen</span>       <span class="hljs-number">8080</span>;<br></code></pre></td></tr></table></figure><p>　　然后我们重新加载一下这个剧本：<br><img src="/../images/1204916-20171208112308109-1548774386.png" srcset="/img/loading.gif" lazyload alt="img"><br>　　发现我们执行的就是reload段以及我们定义的<code>notify</code>部分。<br>　　我们来看一看我们的端口号：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@server ansible]<span class="hljs-comment"># ansible web -m shell -a &#x27;ss -ntlp | grep nginx&#x27;</span><br>192.168.37.122 | SUCCESS | rc=0 &gt;&gt;<br>LISTEN     0      128          *:8080                     *:*                   <span class="hljs-built_in">users</span>:((&quot;nginx&quot;,pid=<span class="hljs-number">2097</span>,fd=<span class="hljs-number">6</span>),(&quot;nginx&quot;,pid=<span class="hljs-number">2096</span>,fd=<span class="hljs-number">6</span>))<br><br>192.168.37.133 | SUCCESS | rc=0 &gt;&gt;<br>LISTEN     0      128          *:8080                     *:*                   <span class="hljs-built_in">users</span>:((&quot;nginx&quot;,pid=<span class="hljs-number">3061</span>,fd=<span class="hljs-number">6</span>),(&quot;nginx&quot;,pid=<span class="hljs-number">3060</span>,fd=<span class="hljs-number">6</span>))<br></code></pre></td></tr></table></figure><p>　　可以看出，我们的nginx端口已经变成了8080。 　　</p><h3 id="4）variables-部分"><a href="#4）variables-部分" class="headerlink" title="4）variables 部分"></a>4）variables 部分</h3><p>　　上文中，我们说到了<code>variables</code>是变量，有四种定义方法，现在我们就来说说这四种定义方法：</p><h4 id="①-facts-：可直接调用"><a href="#①-facts-：可直接调用" class="headerlink" title="① facts ：可直接调用"></a>① facts ：可直接调用</h4><p>　　上一篇中，我们有说到<code>setup</code>这个模块，这个模块就是通过调用facts组件来实现的。我们这里的<code>variables</code>也可以直接调用<code>facts</code>组件。<br>　　具体的<code>facters</code>我们可以使用<code>setup</code>模块来获取，然后直接放入我们的剧本中调用即可。</p><h4 id="②-用户自定义变量"><a href="#②-用户自定义变量" class="headerlink" title="② 用户自定义变量"></a>② 用户自定义变量</h4><p>　　我们也可以直接使用用户自定义变量，想要自定义变量有以下两种方式：</p><blockquote><p>通过命令行传入</p></blockquote><p>　　<code>ansible-playbook</code>命令的命令行中的<code>-e VARS, --extra-vars=VARS</code>，这样就可以直接把自定义的变量传入。</p><blockquote><p>在playbook中定义变量</p></blockquote><p>　　我们也可以直接在playbook中定义我们的变量：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">vars:</span><br>　　<span class="hljs-bullet">-</span> <span class="hljs-attr">var1:</span> <span class="hljs-string">value1</span><br>　　<span class="hljs-bullet">-</span> <span class="hljs-attr">var2:</span> <span class="hljs-string">value2</span><br></code></pre></td></tr></table></figure><h5 id="举例-1"><a href="#举例-1" class="headerlink" title="举例"></a>举例</h5><p><strong>① 定义剧本</strong><br>　　我们就使用全局替换把我们刚刚编辑的文件修改一下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@server ansible]<span class="hljs-comment"># vim nginx.yml</span><br></code></pre></td></tr></table></figure><p><img src="/../images/1204916-20171208112328234-1706127649.png" srcset="/img/loading.gif" lazyload alt="img"><br><img src="/../images/1204916-20171208112334765-1675703855.png" srcset="/img/loading.gif" lazyload alt="img"><br>　　这样一来，我们的剧本就定义完成了。<br><strong>② 拷贝配置文件</strong><br>　　我们想要在被监管的机器上安装什么服务的话，就直接在我们的server端上把该服务的配置文件拷贝到我们的<code>/tmp/</code>目录下。这样我们的剧本才能正常运行。<br>　　我们就以<code>keepalived</code>服务为例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@server ansible]<span class="hljs-comment"># cp /etc/keepalived/keepalived.conf /tmp/keepalived.conf</span><br></code></pre></td></tr></table></figure><p><strong>③ 运行剧本，变量由命令行传入</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@server ansible]<span class="hljs-comment"># ansible-playbook nginx.yml -e rpmname=keepalived</span><br></code></pre></td></tr></table></figure><p><img src="/../images/1204916-20171208112345843-507673332.png" srcset="/img/loading.gif" lazyload alt="img"><br><strong>④ 修改剧本，直接定义变量</strong><br>　　同样的，我们可以直接在剧本中把变量定义好，这样就不需要在通过命令行传入了。以后想要安装不同的服务，直接在剧本里把变量修改一下即可。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@server ansible]<span class="hljs-comment"># vim nginx.yml</span><br></code></pre></td></tr></table></figure><p><img src="/../images/1204916-20171208112356562-1275040347.png" srcset="/img/loading.gif" lazyload alt="img"><br><strong>⑤ 运行定义过变量的剧本</strong><br>　　我们刚刚已经把变量定义在剧本里面了。现在我们来运行一下试试看：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@server ansible]<span class="hljs-comment"># ansible-playbook nginx.yml</span><br></code></pre></td></tr></table></figure><p><img src="/../images/1204916-20171208112404531-432662099.png" srcset="/img/loading.gif" lazyload alt="img"><br>　　发现这样也是可以的~</p><h4 id="③-通过roles传递变量"><a href="#③-通过roles传递变量" class="headerlink" title="③ 通过roles传递变量"></a>③ 通过roles传递变量</h4><p>　　具体的，我们下文中说到 roles 的时候再详细说明。这里是<a target="_blank" rel="noopener" href="https://www.cnblogs.com/keerya/p/8004566.html#jump">传送带</a> 　　</p><h4 id="④-Host-Inventory"><a href="#④-Host-Inventory" class="headerlink" title="④ Host Inventory"></a>④ Host Inventory</h4><p>　　我们也可以直接在主机清单中定义。<br>　　定义的方法如下：</p><blockquote><p>向不同的主机传递不同的变量：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">　　IP/HOSTNAME varaiable=value var2=value2<br></code></pre></td></tr></table></figure><blockquote><p>向组中的主机传递相同的变量：</p></blockquote><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini">　　<span class="hljs-section">[groupname:vars]</span><br>　　<span class="hljs-attr">variable</span>=value<br></code></pre></td></tr></table></figure><h3 id="5）模板-templates"><a href="#5）模板-templates" class="headerlink" title="5）模板 templates"></a>5）模板 templates</h3><p>　　模板是一个文本文件，嵌套有脚本（使用模板编程语言编写）。<br>　　<code>Jinja2</code>：Jinja2是python的一种模板语言，以Django的模板语言为原本。<br>模板支持：</p><blockquote><p>　　字符串：使用单引号或双引号；<br>　　数字：整数，浮点数；<br>　　列表：[item1, item2, …]<br>　　元组：(item1, item2, …)<br>　　字典：{key1:value1, key2:value2, …}<br>　　布尔型：true&#x2F;false<br>　　算术运算：<br>　　　　+, -, *, &#x2F;, &#x2F;&#x2F;, %, **<br>　　比较操作：<br>　　　　&#x3D;&#x3D;, !&#x3D;, &gt;, &gt;&#x3D;, &lt;, &lt;&#x3D;<br>　　逻辑运算：<br>　　　　and, or, not</p></blockquote><p>　　通常来说，模板都是通过引用变量来运用的。</p><h4 id="举例-2"><a href="#举例-2" class="headerlink" title="举例"></a>举例</h4><p><strong>① 定义模板</strong><br>　　我们直接把之前定义的<code>/tmp/nginx.conf</code>改个名，然后编辑一下，就可以定义成我们的模板文件了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@server ansible]<span class="hljs-comment"># cd /tmp</span><br>[root@server tmp]<span class="hljs-comment"># mv nginx.conf nginx.conf.j2</span><br>[root@server tmp]<span class="hljs-comment"># vim nginx.conf.j2</span><br>	worker_processes  &#123;&#123; ansible_processor_vcpus &#125;&#125;;<br>	listen       &#123;&#123; nginxport &#125;&#125;;<br></code></pre></td></tr></table></figure><p><strong>② 修改剧本</strong><br>　　我们现在需要去修改剧本来定义变量：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@server ansible]<span class="hljs-comment"># vim nginx.yml</span><br></code></pre></td></tr></table></figure><p><img src="/../images/1204916-20171208112442234-829367844.png" srcset="/img/loading.gif" lazyload alt="img"><br>　　需要修改的部分如图所示。<br><strong>③ 运行剧本</strong><br>　　上面的准备工作完成后，我们就可以去运行剧本了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@server ansible]<span class="hljs-comment"># ansible-playbook nginx.yml -t reloadnginx</span><br><br>PLAY [web] *********************************************************************<br><br>TASK [setup] *******************************************************************<br>ok: [192.168.37.122]<br>ok: [192.168.37.133]<br><br>TASK [copy nginx.conf] *********************************************************<br>ok: [192.168.37.122]<br>ok: [192.168.37.133]<br><br>PLAY RECAP *********************************************************************<br>192.168.37.122             : ok=2    changed=0    unreachable=0    failed=0   <br>192.168.37.133             : ok=2    changed=0    unreachable=0    failed=0 <br></code></pre></td></tr></table></figure><h3 id="6）条件测试"><a href="#6）条件测试" class="headerlink" title="6）条件测试"></a>6）条件测试</h3><p>when语句：在task中使用，jinja2的语法格式。<br>举例如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">tasks:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">conf</span> <span class="hljs-string">file</span> <span class="hljs-string">to</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">template:</span> <span class="hljs-string">src=files/nginx.conf.c7.j2</span><br>  <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;7&quot;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">conf</span> <span class="hljs-string">file</span> <span class="hljs-string">to</span> <span class="hljs-string">centos6</span><br>  <span class="hljs-attr">template:</span> <span class="hljs-string">src=files/nginx.conf.c6.j2</span><br>  <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;6&quot;</span><br></code></pre></td></tr></table></figure><p>循环：迭代，需要重复执行的任务；<br>　　对迭代项的引用，固定变量名为”item”，而后，要在task中使用with_items给定要迭代的元素列表；<br>举例如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">tasks:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">unstall</span> <span class="hljs-string">web</span> <span class="hljs-string">packages</span><br>  <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=absent</span><br>  <span class="hljs-attr">with_items:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">httpd</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">php</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">php-mysql</span><br></code></pre></td></tr></table></figure><h3 id="7）字典"><a href="#7）字典" class="headerlink" title="7）字典"></a>7）字典</h3><p>　　ansible playbook 还支持字典功能。举例如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">some</span> <span class="hljs-string">packages</span><br>  <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>  <span class="hljs-attr">with_items:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">memcached</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">php-fpm</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">some</span> <span class="hljs-string">groups</span><br>  <span class="hljs-attr">group:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>  <span class="hljs-attr">with_items:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">group11</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">group12</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">group13</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">some</span> <span class="hljs-string">users</span><br>  <span class="hljs-attr">user:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item.name</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">group=&#123;&#123;</span> <span class="hljs-string">item.group</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>  <span class="hljs-attr">with_items:</span><br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;user11&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;group11&#x27;</span> &#125;<br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;user12&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;group12&#x27;</span> &#125;<br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;user13&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;group13&#x27;</span> &#125;<br></code></pre></td></tr></table></figure><h3 id="8）角色订制：roles"><a href="#8）角色订制：roles" class="headerlink" title="8）角色订制：roles"></a>8）角色订制：roles</h3><h4 id="①-简介"><a href="#①-简介" class="headerlink" title="① 简介"></a>① 简介</h4><p>　　对于以上所有的方式有个弊端就是无法实现复用假设在同时部署Web、db、ha 时或不同服务器组合不同的应用就需要写多个yml文件。很难实现灵活的调用。<br>　　roles 用于层次性、结构化地组织playbook。roles 能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可。简单来讲，roles就是通过分别将变量(vars)、文件(file)、任务(tasks)、模块(modules)及处理器(handlers)放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中。</p><h4 id="②-角色集合"><a href="#②-角色集合" class="headerlink" title="② 角色集合"></a>② 角色集合</h4><p>角色集合：roles&#x2F;<br>mysql&#x2F;<br>httpd&#x2F;<br>nginx&#x2F;<br>files&#x2F;：存储由copy或script等模块调用的文件；<br>tasks&#x2F;：此目录中至少应该有一个名为main.yml的文件，用于定义各task；其它的文件需要由main.yml进行“包含”调用；<br>handlers&#x2F;：此目录中至少应该有一个名为main.yml的文件，用于定义各handler；其它的文件需要由main.yml进行“包含”调用；<br>vars&#x2F;：此目录中至少应该有一个名为main.yml的文件，用于定义各variable；其它的文件需要由main.yml进行“包含”调用；<br>templates&#x2F;：存储由template模块调用的模板文本；<br>meta&#x2F;：此目录中至少应该有一个名为main.yml的文件，定义当前角色的特殊设定及其依赖关系；其它的文件需要由main.yml进行“包含”调用；<br>default&#x2F;：此目录中至少应该有一个名为main.yml的文件，用于设定默认变量；</p><h4 id="③-角色定制实例"><a href="#③-角色定制实例" class="headerlink" title="③ 角色定制实例"></a>③ 角色定制实例</h4><p><strong>1. 在roles目录下生成对应的目录结构</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@server ansible]<span class="hljs-comment"># cd roles/</span><br>[root@server roles]<span class="hljs-comment"># ls</span><br>[root@server roles]<span class="hljs-comment"># mkdir -pv ./&#123;nginx,mysql,httpd&#125;/&#123;files,templates,vars,tasks,handlers,meta,default&#125;</span><br>[root@server roles]<span class="hljs-comment"># tree</span><br>.<br>├── httpd<br>│   ├── default<br>│   ├── files<br>│   ├── handlers<br>│   ├── meta<br>│   ├── tasks<br>│   ├── templates<br>│   └── vars<br>├── mysql<br>│   ├── default<br>│   ├── files<br>│   ├── handlers<br>│   ├── meta<br>│   ├── tasks<br>│   ├── templates<br>│   └── vars<br>└── nginx<br>    ├── default<br>    ├── files<br>    ├── handlers<br>    ├── meta<br>    ├── tasks<br>    ├── templates<br>    └── vars<br><br>24 directories, 0 files<br></code></pre></td></tr></table></figure><p><strong>2. 定义配置文件</strong><br>　　我们需要修改的配置文件为<code>/tasks/main.yml</code>，下面，我们就来修改一下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@server</span> <span class="hljs-string">roles</span>]<span class="hljs-comment"># vim nginx/tasks/main.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cp</span><br>  <span class="hljs-attr">copy:</span> <span class="hljs-string">src=nginx-1.10.2-1.el7.ngx.x86_64.rpm</span> <span class="hljs-string">dest=/tmp/nginx-1.10.2-1.el7.ngx.x86_64.rpm</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span><br>  <span class="hljs-attr">yum:</span> <span class="hljs-string">name=/tmp/nginx-1.10.2-1.el7.ngx.x86_64.rpm</span> <span class="hljs-string">state=latest</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">conf</span><br>  <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf.j2</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br>  <span class="hljs-attr">tags:</span> <span class="hljs-string">nginxconf</span><br>  <span class="hljs-attr">notify:</span> <span class="hljs-string">new</span> <span class="hljs-string">conf</span> <span class="hljs-string">to</span> <span class="hljs-string">reload</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">service</span><br>  <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=true</span><br></code></pre></td></tr></table></figure><p><strong>3. 放置我们所需要的文件到指定目录</strong><br>　　因为我们定义的角色已经有了新的组成方式，所以我们需要把文件都放到指定的位置，这样，才能让配置文件找到这些并进行加载。<br>　　rpm包放在<code>files</code>目录下，模板放在<code>templates</code>目录下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@server nginx]<span class="hljs-comment"># cp /tmp/nginx-1.10.2-1.el7.ngx.x86_64.rpm ./files/</span><br>[root@server nginx]<span class="hljs-comment"># cp /tmp/nginx.conf.j2 ./templates/</span><br>[root@server nginx]<span class="hljs-comment"># tree</span><br>.<br>├── default<br>├── files<br>│   └── nginx-1.10.2-1.el7.ngx.x86_64.rpm<br>├── handlers<br>├── meta<br>├── tasks<br>│   └── main.yml<br>├── templates<br>│   └── nginx.conf.j2<br>└── vars<br><br>7 directories, 3 files<br></code></pre></td></tr></table></figure><p><strong>4. 修改变量文件</strong><br>　　我们在模板中定义的变量，也要去配置文件中加上：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@server</span> <span class="hljs-string">nginx</span>]<span class="hljs-comment"># vim vars/main.yml</span><br><span class="hljs-attr">nginxprot:</span> <span class="hljs-number">9999</span><br></code></pre></td></tr></table></figure><p><strong>5. 定义handlers文件</strong><br>　　我们在配置文件中定义了<code>notify</code>，所以我么也需要定义<code>handlers</code>，我们来修改配置文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@server</span> <span class="hljs-string">nginx</span>]<span class="hljs-comment"># vim handlers/main.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">new</span> <span class="hljs-string">conf</span> <span class="hljs-string">to</span> <span class="hljs-string">reload</span><br>  <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=restarted</span><br></code></pre></td></tr></table></figure><p><strong>6. 定义剧本文件</strong><br>　　接下来，我们就来定义剧本文件，由于大部分设置我们都单独配置在了roles里面，所以，接下来剧本就只需要写一点点内容即可：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@server</span> <span class="hljs-string">ansible</span>]<span class="hljs-comment"># vim roles.yml </span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">web</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">nginx</span><br></code></pre></td></tr></table></figure><p><strong>7. 启动服务</strong><br>　　剧本定义完成以后，我们就可以来启动服务了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@server ansible]<span class="hljs-comment"># ansible-playbook roles.yml</span><br><br>PLAY [web] *********************************************************************<br><br>TASK [setup] *******************************************************************<br>ok: [192.168.37.122]<br>ok: [192.168.37.133]<br><br>TASK [nginx : <span class="hljs-built_in">cp</span>] **************************************************************<br>ok: [192.168.37.122]<br>ok: [192.168.37.133]<br><br>TASK [nginx : install] *********************************************************<br>changed: [192.168.37.122]<br>changed: [192.168.37.133]<br><br>TASK [nginx : conf] ************************************************************<br>changed: [192.168.37.122]<br>changed: [192.168.37.133]<br><br>TASK [nginx : start service] ***************************************************<br>changed: [192.168.37.122]<br>changed: [192.168.37.133]<br><br>RUNNING HANDLER [nginx : new conf to reload] ***********************************<br>changed: [192.168.37.122]<br>changed: [192.168.37.133]<br><br>PLAY RECAP *********************************************************************<br>192.168.37.122             : ok=6    changed=4    unreachable=0    failed=0   <br>192.168.37.133             : ok=6    changed=4    unreachable=0    failed=0   <br></code></pre></td></tr></table></figure><p>　　启动过后照例查看端口号：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@server ansible]<span class="hljs-comment"># ansible web -m shell -a &quot;ss -ntulp |grep 9999&quot;</span><br>192.168.37.122 | SUCCESS | rc=0 &gt;&gt;<br>tcp    LISTEN     0      128       *:9999                  *:*                   <span class="hljs-built_in">users</span>:((&quot;nginx&quot;,pid=<span class="hljs-number">7831</span>,fd=<span class="hljs-number">6</span>),(&quot;nginx&quot;,pid=<span class="hljs-number">7830</span>,fd=<span class="hljs-number">6</span>),(&quot;nginx&quot;,pid=<span class="hljs-number">7829</span>,fd=<span class="hljs-number">6</span>))<br><br>192.168.37.133 | SUCCESS | rc=0 &gt;&gt;<br>tcp    LISTEN     0      128       *:9999                  *:*                   <span class="hljs-built_in">users</span>:((&quot;nginx&quot;,pid=<span class="hljs-number">9654</span>,fd=<span class="hljs-number">6</span>),(&quot;nginx&quot;,pid=<span class="hljs-number">9653</span>,fd=<span class="hljs-number">6</span>),(&quot;nginx&quot;,pid=<span class="hljs-number">9652</span>,fd=<span class="hljs-number">6</span>))<br></code></pre></td></tr></table></figure><p>可以看出我们的剧本已经执行成功。</p><hr><p><a target="_blank" rel="noopener" href="https://www.msft.vip/2023/01/31/Ansible-Detailed-Tutorial-I/">Ansible-Detailed-Tutorial-I</a></p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/linux/" class="category-chain-item">linux</a></span></span></div></div><div class="license-box my-3"><div class="license-title"><div>Ansible Detailed Tutorial II</div><div>https://git.msft.vip/2023/01/31-Ansible-Detailed-Tutorial-II/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Jas0n0ss</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年1月31日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2024年8月9日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i> </span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/"><span class="hint--top hint--rounded" aria-label="ND - 禁止演绎"><i class="iconfont icon-nd"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/02/10-custom-exsi-iso-with-Additional-driver/" title="custom exsi iso with Additional driver"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">custom exsi iso with Additional driver</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/01/31-Ansible-Detailed-Tutorial-I/" title="Ansible Detailed Tutorial I"><span class="hidden-mobile">Ansible Detailed Tutorial I</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script>Fluid.utils.loadComments("#disqus_thread",(function(){Fluid.utils.createCssLink("https://cdn.staticfile.org/disqusjs/1.3.0/disqusjs.css"),Fluid.utils.createScript("https://cdn.staticfile.org/disqusjs/1.3.0/disqus.js",(function(){new DisqusJS({shortname:"fluid",apikey:""})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></div></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><script>Fluid.utils.createScript("https://cdn.staticfile.org/mermaid/8.14.0/mermaid.min.js",(function(){mermaid.initialize({theme:"default"}),Fluid.events.registerRefreshCallback((function(){"mermaid"in window&&mermaid.init()}))}))</script><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Copyrights</span></a> <i class="iconfont icon-love"></i> <a href="https://git.msft.vip" target="_blank" rel="nofollow noopener"><span>Jas0n0ss</span></a></div></div></footer><script src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://cdn.staticfile.org/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://cdn.staticfile.org/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://cdn.staticfile.org/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://cdn.staticfile.org/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>