<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/images/logo.png"><link rel="icon" href="/images/logo.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Jas0n0ss"><meta name="keywords" content="oss"><meta name="description" content="ansible-manage-windows-server"><meta property="og:type" content="article"><meta property="og:title" content="ansible-manage-windows-server"><meta property="og:url" content="https://git.msft.vip/2022/09/20-ansible-manage-windows-server/index.html"><meta property="og:site_name" content="git.msft.vip"><meta property="og:description" content="ansible-manage-windows-server"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-09-20T08:43:47.000Z"><meta property="article:modified_time" content="2024-08-09T12:13:50.169Z"><meta property="article:author" content="Jas0n0ss"><meta property="article:tag" content="Ansible"><meta name="twitter:card" content="summary_large_image"><meta name="referrer" content="no-referrer-when-downgrade"><title>ansible-manage-windows-server - git.msft.vip</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/custom_icon/other/iconfont.css"><link rel="stylesheet" href="/css/custom_icon/phone/iconfont.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"git.msft.vip",root:"/",version:"1.9.4",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Jas0n0ss</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-shouye"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives"><i class="iconfont icon-guidang"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/tags"><i class="iconfont icon-biaoqian"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/video"><i class="iconfont icon-youtube"></i> <span>视频</span></a></li><li class="nav-item"><a class="nav-link" href="/music"><i class="iconfont icon-tubiaozhizuomobanyihuifu-"></i> <span>音乐</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/code.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="ansible-manage-windows-server"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Jas0n0ss </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-09-20 16:43" pubdate>2022年9月20日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 6.6k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 56 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">ansible-manage-windows-server</h1><p class="note note-info">本文最后更新于：2024年8月9日 晚上</p><div class="markdown-body"><h4 id="Windows-Server-Ansible-Setup"><a href="#Windows-Server-Ansible-Setup" class="headerlink" title="Windows Server Ansible Setup"></a>Windows Server Ansible Setup</h4><h5 id="1-Upgrade-Powershell-to-V4-0-above"><a href="#1-Upgrade-Powershell-to-V4-0-above" class="headerlink" title="1.Upgrade Powershell to V4.0 above"></a>1.Upgrade Powershell to V4.0 above</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-number">1</span>. 检查powershell版本<br><span class="hljs-built_in">get-host</span><br><br><span class="hljs-number">2</span>. 下载并安装Microsoft .NET Framework <span class="hljs-number">4.5</span><br>下载地址：<br>https://download.microsoft.com/download/B/A/<span class="hljs-number">4</span>/BA4A7E71<span class="hljs-literal">-2906-4B2D-A0E1-80CF16844F5F</span>/dotNetFx45_Full_setup.exe<br><br><span class="hljs-number">3</span>. 下载并安装powershell4.<span class="hljs-number">0</span>(Windows Management Framework <span class="hljs-number">4.0</span> )<br>下载地址：<br>https://download.microsoft.com/download/<span class="hljs-number">3</span>/D/<span class="hljs-number">6</span>/<span class="hljs-number">3</span>D61D262<span class="hljs-literal">-8549-4769-A660-230B67E15B25</span>/Windows6.<span class="hljs-number">1</span><span class="hljs-literal">-KB2819745-x64-MultiPkg</span>.msu<br></code></pre></td></tr></table></figure><blockquote><p>注意： 先安装.NET Framework 4.5 ，然后安装powershell4.0，安装完成之后重启windows服务器</p></blockquote><h5 id="2-Enable-Winrm-and-Enable-Powershell-Remote-Management"><a href="#2-Enable-Winrm-and-Enable-Powershell-Remote-Management" class="headerlink" title="2. Enable Winrm and Enable Powershell Remote Management"></a>2. Enable Winrm and Enable Powershell Remote Management</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-number">1</span>. 查看powershell执行策略<br><span class="hljs-built_in">get-executionpolicy</span><br><br><span class="hljs-number">2</span>. 更改powershell执行策略为remotesigned<br><span class="hljs-built_in">set-executionpolicy</span> remotesigned<br><br><span class="hljs-number">3</span>. 配置winrm service并启动服务<br>winrm quickconfig<br><br><span class="hljs-number">4</span>. 查看winrm service启动监听状态<br>winrm enumerate winrm/config/listener<br><br><span class="hljs-number">5</span>. 修改winrm配置，启用远程连接认证<br>winrm <span class="hljs-built_in">set</span> winrm/config/service/auth <span class="hljs-string">&#x27;@&#123;Basic=&quot;true&quot;&#125;&#x27;</span><br>winrm <span class="hljs-built_in">set</span> winrm/config/service <span class="hljs-string">&#x27;@&#123;AllowUnencrypted=&quot;true&quot;&#125;&#x27;</span><br></code></pre></td></tr></table></figure><h5 id="3-Windows-firewall-open-for-Winrm"><a href="#3-Windows-firewall-open-for-Winrm" class="headerlink" title="3. Windows firewall open for Winrm"></a>3. Windows firewall open for Winrm</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell">查看winrm service启动监听状态<br>winrm enumerate winrm/config/listener<br>添加防火墙信任规则，允许<span class="hljs-number">5985</span>端口通过<br></code></pre></td></tr></table></figure><h5 id="4-Ansible-master"><a href="#4-Ansible-master" class="headerlink" title="4.  Ansible master"></a>4. Ansible master</h5><h6 id="1-Ansible-master-configure"><a href="#1-Ansible-master-configure" class="headerlink" title="1. Ansible master configure"></a>1. Ansible master configure</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 添加windows客户端连接信息</span><br>vim /etc/ansible/hosts<br>[win]<br>172.16.37.3 ansible_ssh_user=<span class="hljs-string">&quot;Administrator&quot;</span> ansible_ssh_pass=<span class="hljs-string">&quot;Westlife@#ibm&quot;</span> ansible_ssh_port=5985 ansible_connection=<span class="hljs-string">&quot;winrm&quot;</span> ansible_winrm_server_cert_validation=ignore<br><br><span class="hljs-comment"># 安装winrm 模块</span><br>pip search pywinrm <span class="hljs-comment"># pip search 没办法用了</span><br>pi p install pywinrm <span class="hljs-comment"># 无法安装，需要具体版本</span><br>pip install <span class="hljs-string">&quot;pywinrm&gt;=0.2.2&quot;</span>  <span class="hljs-comment"># 这样安装</span><br></code></pre></td></tr></table></figure><h6 id="2-测试ping探测windows客户主机是否存活"><a href="#2-测试ping探测windows客户主机是否存活" class="headerlink" title="2. 测试ping探测windows客户主机是否存活"></a>2. 测试ping探测windows客户主机是否存活</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible win -m win_ping<br></code></pre></td></tr></table></figure><h6 id="3-测试文件管理"><a href="#3-测试文件管理" class="headerlink" title="3. 测试文件管理"></a>3. 测试文件管理</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">测试在windows主机执行远程创建目录<br><span class="hljs-comment"># ansible win -m win_file -a &#x27;dest=c:\config_dir state=directory&#x27;</span><br><br>测试将ansible主机上的/etc/hosts文件同步到windows主机的指定目录下<br><span class="hljs-comment"># ansible win -m win_copy -a &#x27;src=/etc/hosts dest=c:\config_dir\hosts.txt&#x27;</span><br><br>删除文件<br><span class="hljs-comment"># ansible win -m win_file -a &#x27;dest=c:\config_dir\hosts.txt state=absent&#x27;</span><br><br>删除目录<br><span class="hljs-comment"># ansible win -m win_file -a &#x27;dest=c:\config_dir2 state=absent&#x27;</span><br></code></pre></td></tr></table></figure><h6 id="4-测试远程执行cmd命令"><a href="#4-测试远程执行cmd命令" class="headerlink" title="4. 测试远程执行cmd命令"></a>4. 测试远程执行cmd命令</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ansible win -m win_shell -a &#x27;ipconfig&#x27;</span><br></code></pre></td></tr></table></figure><h6 id="5-远程重启windows服务器"><a href="#5-远程重启windows服务器" class="headerlink" title="5. 远程重启windows服务器"></a>5. 远程重启windows服务器</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ansible 172.16.10.23 -m win_reboot</span><br><br><span class="hljs-comment"># ansible 172.16.10.23 -m win_shell -a &#x27;shutdown -r -t 0&#x27;</span><br></code></pre></td></tr></table></figure><h6 id="6-Windows服务管理"><a href="#6-Windows服务管理" class="headerlink" title="6. Windows服务管理"></a>6. Windows服务管理</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">Ansible命令格式：<br>ansible [主机|主机组] -m win_shell -a “net stop|start 服务名”<br></code></pre></td></tr></table></figure><h6 id="7-测试创建用户-远程在windows客户端上创建用户"><a href="#7-测试创建用户-远程在windows客户端上创建用户" class="headerlink" title="7. 测试创建用户(远程在windows客户端上创建用户)"></a>7. 测试创建用户(远程在windows客户端上创建用户)</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ansible win -m win_user -a &quot;name=winuser passwd=windows&quot;</span><br></code></pre></td></tr></table></figure><h6 id="8-使用举例"><a href="#8-使用举例" class="headerlink" title="8. 使用举例"></a>8. 使用举例</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible-console<br>root@all (3)[f:10]$ <span class="hljs-built_in">cd</span> win<br>root@win (1)[f:10]$ list<br>172.16.37.3<br>root@win (1)[f:10]$ win_hostname name=win2k2016  <span class="hljs-comment">#更改主机名</span><br>172.16.37.3 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-string">&quot;old_name&quot;</span>: <span class="hljs-string">&quot;WIN-UIS7GLE4Q9K&quot;</span>,<br>    <span class="hljs-string">&quot;reboot_required&quot;</span>: <span class="hljs-literal">true</span><br>&#125;<br>root@win (1)[f:10]$ win_reboot msg=<span class="hljs-string">&quot;Ansible reboot in next 15s!!!&quot;</span> pre_reboot_delay=15  <span class="hljs-comment">#重启机器</span><br>172.16.37.3 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-string">&quot;elapsed&quot;</span>: 190,<br>    <span class="hljs-string">&quot;rebooted&quot;</span>: <span class="hljs-literal">true</span><br>&#125;<br>root@win (1)[f:10]$ win_<br>Display all 106 possibilities? (y or n)<br>win_acl                      win_environment              win_netbios                  win_scheduled_task<br>win_acl_inheritance          win_eventlog                 win_nssm                     win_scheduled_task_stat<br>win_audit_policy_system      win_eventlog_entry           win_optional_feature         win_security_policy<br>win_audit_rule               win_feature                  win_owner                    win_service<br>win_certificate_store        win_file                     win_package                  win_share<br></code></pre></td></tr></table></figure><h4 id="常用的ansible-模块"><a href="#常用的ansible-模块" class="headerlink" title="常用的ansible 模块"></a>常用的ansible 模块</h4><p>参考地址：</p><p><a target="_blank" rel="noopener" href="http://www.yunweipai.com/go?_=1c6a53dc99aHR0cHM6Ly9kb2NzLmFuc2libGUuY29tL2Fuc2libGUvbGF0ZXN0L21vZHVsZXMvbW9kdWxlc19ieV9jYXRlZ29yeS5odG1s">https://docs.ansible.com/ansible/latest/modules/modules_by_category.html</a></p><hr><p>常用的模块：</p><p><code>ping</code>，<code>command</code> ，<code>shell</code> ，<code>script</code>，<code>copy</code> ， <code>fetch</code>，<code>hostname</code>，<code>file</code>，<code>unarchive</code> ， <code>archive</code>，<code>yum</code>，<code>cron</code>，<code>service</code>，<code>user</code> ， <code>group</code>，<code>lineinfile</code> ，<code>replace</code>，<code>setup</code>…</p><p>command &amp; shell:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 注意区别和相同</span><br><span class="hljs-comment"># command 不能识别变量以及引号内容</span><br>root@unix (2)[f:10]$ <span class="hljs-built_in">command</span> <span class="hljs-built_in">echo</span> <span class="hljs-variable">$HOSTNAME</span><br>172.16.37.2 | CHANGED | rc=0 &gt;&gt;<br><span class="hljs-variable">$HOSTNAME</span><br>172.16.37.4 | CHANGED | rc=0 &gt;&gt;<br><span class="hljs-variable">$HOSTNAME</span><br>root@unix (2)[f:10]$ shell <span class="hljs-built_in">echo</span> <span class="hljs-variable">$HOSTNAME</span><br>172.16.37.2 | CHANGED | rc=0 &gt;&gt;<br>ansible-master<br>172.16.37.4 | CHANGED | rc=0 &gt;&gt;<br>ansible-node1<br>root@node1 (1)[f:10]$ shell <span class="hljs-built_in">echo</span> passwd |passwd --stdin <span class="hljs-built_in">test</span><br>172.16.37.4 | CHANGED | rc=0 &gt;&gt;<br>更改用户 <span class="hljs-built_in">test</span> 的密码 。<br>passwd：所有的身份验证令牌已经成功更新。<br>root@node1 (1)[f:10]$ <span class="hljs-built_in">command</span> <span class="hljs-built_in">echo</span> passwd |passwd --stdin <span class="hljs-built_in">test</span><br>172.16.37.4 | CHANGED | rc=0 &gt;&gt;<br>passwd |passwd --stdin <span class="hljs-built_in">test</span><br></code></pre></td></tr></table></figure><p>unarchive &amp; archive:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible all -m unarchive -a <span class="hljs-string">&#x27;src=/tmp/foo.zip dest=/data copy=no mode=0777&#x27;</span><br>ansible all -m unarchive -a <span class="hljs-string">&#x27;src=https://example.com/example.zip dest=/data copy=no&#x27;</span><br>ansible websrvs -m archive  -a <span class="hljs-string">&#x27;path=/var/log/ dest=/data/log.tar.bz2 format=bz2  owner=wang mode=0600&#x27;</span><br></code></pre></td></tr></table></figure><p>cron:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#备份数据库脚本</span><br>[root@centos8 ~]<span class="hljs-comment">#cat mysql_backup.sh </span><br>mysqldump -A -F --single-transaction --master-data=2 -q -uroot |gzip &gt; /data/mysql_date +%F_%T.sql.gz<br><span class="hljs-comment">#创建任务</span><br>ansible 10.0.0.8 -m cron -a <span class="hljs-string">&#x27;hour=2 minute=30 weekday=1-5 name=&quot;backup mysql&quot; job=/root/mysql_backup.sh&#x27;</span><br>ansible websrvs   -m cron -a <span class="hljs-string">&quot;minute=*/5 job=&#x27;/usr/sbin/ntpdate 172.20.0.1 &amp;&gt;/dev/null&#x27; name=Synctime&quot;</span><br><span class="hljs-comment">#禁用计划任务</span><br>ansible websrvs   -m cron -a <span class="hljs-string">&quot;minute=*/5 job=&#x27;/usr/sbin/ntpdate 172.20.0.1 &amp;&gt;/dev/null&#x27; name=Synctime disabled=yes&quot;</span><br><span class="hljs-comment">#启用计划任务</span><br>ansible websrvs   -m cron -a <span class="hljs-string">&quot;minute=*/5 job=&#x27;/usr/sbin/ntpdate 172.20.0.1 &amp;&gt;/dev/null&#x27; name=Synctime disabled=no&quot;</span><br><span class="hljs-comment">#删除任务</span><br>ansible websrvs -m cron -a <span class="hljs-string">&quot;name=&#x27;backup mysql&#x27; state=absent&quot;</span><br>ansible websrvs -m cron -a <span class="hljs-string">&#x27;state=absent name=Synctime&#x27;</span><br></code></pre></td></tr></table></figure><p>service:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible all -m service -a <span class="hljs-string">&#x27;name=httpd state=started enabled=yes&#x27;</span><br>ansible all -m service -a <span class="hljs-string">&#x27;name=httpd state=stopped&#x27;</span><br>ansible all -m service -a <span class="hljs-string">&#x27;name=httpd state=reloaded’</span><br><span class="hljs-string">ansible all -m shell -a &quot;sed -i &#x27;</span>s/^Listen 80/Listen 8080/<span class="hljs-string">&#x27; /etc/httpd/conf/httpd.conf&quot;</span><br><span class="hljs-string">ansible all -m service -a &#x27;</span>name=httpd state=restarted<span class="hljs-string">&#x27; </span><br></code></pre></td></tr></table></figure><p>user &amp; group:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建用户</span><br>ansible all -m user -a <span class="hljs-string">&#x27;name=user1 comment=“test user” uid=2048 home=/app/user1 group=root&#x27;</span><br>ansible all -m user -a <span class="hljs-string">&#x27;name=nginx comment=nginx uid=88 group=nginx groups=&quot;root,daemon&quot; shell=/sbin/nologin system=yes create_home=no  home=/data/nginx non_unique=yes&#x27;</span><br><span class="hljs-comment">#删除用户及家目录等数据</span><br>ansible all -m user -a <span class="hljs-string">&#x27;name=nginx state=absent remove=yes&#x27;</span><br><span class="hljs-comment">#创建组</span><br>ansible websrvs -m group  -a <span class="hljs-string">&#x27;name=nginx gid=88 system=yes&#x27;</span><br><span class="hljs-comment">#删除组</span><br>ansible websrvs -m group  -a <span class="hljs-string">&#x27;name=nginx state=absent&#x27;</span><br></code></pre></td></tr></table></figure><p>lineinfile:</p><p>ansible在使用sed进行替换时，经常会遇到需要转义的问题，而且ansible在遇到特殊符号进行替换时，存在问题，无法正常进行替换 。其实在ansible自身提供了两个模块：lineinfile模块和replace模块，可以方便的进行替换功能：相当于sed，可以修改文件内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible all -m   lineinfile -a <span class="hljs-string">&quot;path=/etc/selinux/config regexp=&#x27;^SELINUX=&#x27; line=&#x27;SELINUX=enforcing&#x27;&quot;</span><br>ansible all -m lineinfile  -a <span class="hljs-string">&#x27;dest=/etc/fstab state=absent regexp=&quot;^#&quot;&#x27;</span><br></code></pre></td></tr></table></figure><p>replace:</p><p>该模块有点类似于sed命令，主要也是基于正则进行匹配和替换</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible all -m replace -a <span class="hljs-string">&quot;path=/etc/fstab regexp=&#x27;^(UUID.*)&#x27; replace=&#x27;#\1&#x27;&quot;</span>  <br>ansible all -m replace -a <span class="hljs-string">&quot;path=/etc/fstab regexp=&#x27;^#(.*)&#x27; replace=&#x27;\1&#x27;&quot;</span><br></code></pre></td></tr></table></figure><p>setup:</p><p>setup 模块来收集主机的系统信息，这些 facts 信息可以直接以变量的形式使用，但是如果主机较多，会影响执行速度，可以使用<code>gather_facts: no</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible all -m setup<br>ansible all -m setup -a <span class="hljs-string">&quot;filter=ansible_os_family</span><br><span class="hljs-string">ansible all -m setup -a &quot;</span>filter=ansible_hostname<span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/keerya/p/7987886.html">https://www.cnblogs.com/keerya/p/7987886.html</a></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/keerya/p/8004566.html">https://www.cnblogs.com/keerya/p/8004566.html</a></p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/linux/" class="category-chain-item">linux</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/Ansible/">#Ansible</a></div></div><div class="license-box my-3"><div class="license-title"><div>ansible-manage-windows-server</div><div>https://git.msft.vip/2022/09/20-ansible-manage-windows-server/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Jas0n0ss</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2022年9月20日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2024年8月9日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i> </span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/"><span class="hint--top hint--rounded" aria-label="ND - 禁止演绎"><i class="iconfont icon-nd"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2022/09/20-openshift-setup-with-ansible/" title="openshift-setup-with-ansible-playbook"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">openshift-setup-with-ansible-playbook</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2022/09/20-HeartBeat-DRDB-Mysql-HighAvalibity/" title="HeartBeat-DRDB-Mysql-high-Availability"><span class="hidden-mobile">HeartBeat-DRDB-Mysql-high-Availability</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script>Fluid.utils.loadComments("#disqus_thread",(function(){Fluid.utils.createCssLink("https://cdn.staticfile.org/disqusjs/1.3.0/disqusjs.css"),Fluid.utils.createScript("https://cdn.staticfile.org/disqusjs/1.3.0/disqus.js",(function(){new DisqusJS({shortname:"fluid",apikey:""})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></div></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><script>Fluid.utils.createScript("https://cdn.staticfile.org/mermaid/8.14.0/mermaid.min.js",(function(){mermaid.initialize({theme:"default"}),Fluid.events.registerRefreshCallback((function(){"mermaid"in window&&mermaid.init()}))}))</script><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Copyrights</span></a> <i class="iconfont icon-love"></i> <a href="https://git.msft.vip" target="_blank" rel="nofollow noopener"><span>Jas0n0ss</span></a></div></div></footer><script src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://cdn.staticfile.org/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://cdn.staticfile.org/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://cdn.staticfile.org/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://cdn.staticfile.org/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>