<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/images/logo.png"><link rel="icon" href="/images/logo.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Jas0n0ss"><meta name="keywords" content="oss"><meta name="description" content="Prometheus Tutorial"><meta property="og:type" content="article"><meta property="og:title" content="Prometheus Tutorial"><meta property="og:url" content="https://git.msft.vip/2022/12/23-prometheus-Tutorial/index.html"><meta property="og:site_name" content="git.msft.vip"><meta property="og:description" content="Prometheus Tutorial"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://git.msft.vip/images/prometheus-native-ui.png"><meta property="og:image" content="https://git.msft.vip/images/grafana-login.png"><meta property="og:image" content="https://git.msft.vip/images/grafana-login-pass.png"><meta property="og:image" content="https://git.msft.vip/images/grafana-login-home.png"><meta property="og:image" content="https://git.msft.vip/images/grafana-add-first-source.png"><meta property="og:image" content="https://git.msft.vip/images/grafana-select.png"><meta property="og:image" content="https://git.msft.vip/images/prometheus-dashboard.png"><meta property="og:image" content="https://git.msft.vip/images/prometheus-settings.png"><meta property="og:image" content="https://git.msft.vip/images/prometheus-dashboard-2.0.png"><meta property="og:image" content="https://git.msft.vip/images/ne-manage.png"><meta property="og:image" content="https://git.msft.vip/images/ne-import.png"><meta property="og:image" content="https://git.msft.vip/images/ne-upload.png"><meta property="og:image" content="https://git.msft.vip/images/ne-rename1.png"><meta property="og:image" content="https://git.msft.vip/images/ne-no-plugin.png"><meta property="og:image" content="https://git.msft.vip/images/ne-success.png"><meta property="og:image" content="https://git.msft.vip/images/mysqld-6.png"><meta property="og:image" content="https://git.msft.vip/images/mysqld-7.png"><meta property="og:image" content="https://git.msft.vip/images/mysqld-8.png"><meta property="og:image" content="https://git.msft.vip/images/mysqld-9.png"><meta property="og:image" content="https://git.msft.vip/images/grafana-import-id.png"><meta property="og:image" content="https://git.msft.vip/images/grafana-import-rename.png"><meta property="og:image" content="https://git.msft.vip/images/grafana-import-mysql.png"><meta property="og:image" content="https://git.msft.vip/images/grafana-redis-dash.png"><meta property="og:image" content="https://git.msft.vip/images/grafana-es-dash.png"><meta property="og:image" content="https://git.msft.vip/images/grafana-mq-dash1.png"><meta property="og:image" content="https://git.msft.vip/images/grafana-mq-dash2.png"><meta property="og:image" content="https://git.msft.vip/images/jmx-dash.png"><meta property="article:published_time" content="2022-12-23T09:54:45.000Z"><meta property="article:modified_time" content="2024-08-09T12:13:50.173Z"><meta property="article:author" content="Jas0n0ss"><meta property="article:tag" content="Prometheus"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://git.msft.vip/images/prometheus-native-ui.png"><meta name="referrer" content="no-referrer-when-downgrade"><title>Prometheus Tutorial - git.msft.vip</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/custom_icon/other/iconfont.css"><link rel="stylesheet" href="/css/custom_icon/phone/iconfont.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"git.msft.vip",root:"/",version:"1.9.4",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Jas0n0ss</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-shouye"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives"><i class="iconfont icon-guidang"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/tags"><i class="iconfont icon-biaoqian"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/video"><i class="iconfont icon-youtube"></i> <span>视频</span></a></li><li class="nav-item"><a class="nav-link" href="/music"><i class="iconfont icon-tubiaozhizuomobanyihuifu-"></i> <span>音乐</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/code.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Prometheus Tutorial"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Jas0n0ss </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-12-23 17:54" pubdate>2022年12月23日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 13k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 106 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">Prometheus Tutorial</h1><p class="note note-info">本文最后更新于：2024年8月9日 晚上</p><div class="markdown-body"><h2 id="0-简介"><a href="#0-简介" class="headerlink" title="0 简介"></a>0 简介</h2><p>Prometheus是最初在SoundCloud上构建的开源系统监视和警报工具包 。自2012年成立以来，许多公司和组织都采用了Prometheus，该项目拥有非常活跃的开发人员和用户社区。现在，它是一个独立的开源项目，并且独立于任何公司进行维护。为了强调这一点并阐明项目的治理结构，Prometheus 在2016年加入了 Cloud Native Computing Foundation，这是继Kubernetes之后的第二个托管项目。</p><ul><li>强大的多维度数据模型。</li><li>时间序列数据通过 metric 名和键值对来区分。</li><li>所有的 metrics 都可以设置任意的多维标签。</li><li>数据模型更随意，不需要刻意设置为以点分隔的字符串。</li><li>可以对数据模型进行聚合，切割和切片操作。</li><li>支持双精度浮点类型，标签可以设为全 unicode。</li><li>灵活而强大的查询语句（PromQL）：在同一个查询语句，可以对多个 metrics 进行乘法、加法、连接、取分数位等操作。</li><li>易于管理： Prometheus server 是一个单独的二进制文件，可直接在本地工作，不依赖于分布式存储。</li><li>高效：平均每个采样点仅占 3.5 bytes，且一个 Prometheus server 可以处理数百万的 metrics。</li><li>使用 pull 模式采集时间序列数据，这样不仅有利于本机测试而且可以避免有问题的服务器推送坏的 metrics。</li><li>可以采用 push gateway 的方式把时间序列数据推送至 Prometheus server 端。</li><li>可以通过服务发现或者静态配置去获取监控的 targets。</li><li>有多种可视化图形界面。</li><li>易于伸缩。</li></ul><h2 id="1-基础环境"><a href="#1-基础环境" class="headerlink" title="1 基础环境"></a>1 基础环境</h2><table><thead><tr><th>环境&#x2F;组件</th><th>版本</th><th>下载地址</th></tr></thead><tbody><tr><td>操作系统</td><td>CentOS7.6</td><td><a target="_blank" rel="noopener" href="https://archive.kernel.org/centos-vault/7.6.1810/isos/x86_64/CentOS-7-x86_64-Minimal-1810.iso">https://archive.kernel.org/centos-vault/7.6.1810/isos/x86_64/CentOS-7-x86_64-Minimal-1810.iso</a></td></tr><tr><td>Prometheus</td><td>2.25.0</td><td><a target="_blank" rel="noopener" href="https://github.com/prometheus/prometheus/releases/download/v2.25.0/prometheus-2.25.0.linux-amd64.tar.gz">https://github.com/prometheus/prometheus/releases/download/v2.25.0/prometheus-2.25.0.linux-amd64.tar.gz</a></td></tr><tr><td>Go</td><td>1.16</td><td><a target="_blank" rel="noopener" href="https://golang.org/dl/go1.16.linux-amd64.tar.gz">https://golang.org/dl/go1.16.linux-amd64.tar.gz</a></td></tr><tr><td>Grafana</td><td>yum install latest</td><td><a target="_blank" rel="noopener" href="https://mirror.tuna.tsinghua.edu.cn/help/grafana/">https://mirror.tuna.tsinghua.edu.cn/help/grafana/</a></td></tr></tbody></table><h2 id="2-安装Prometheus"><a href="#2-安装Prometheus" class="headerlink" title="2 安装Prometheus"></a>2 安装Prometheus</h2><h3 id="2-1-安装"><a href="#2-1-安装" class="headerlink" title="2.1 安装"></a>2.1 安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">tar zxf prometheus-2.25.0.linux-amd64.tar.gz -C /opt<br><span class="hljs-built_in">mv</span> /opt/prometheus-2.25.0.linux-amd64 /opt/prometheus<br></code></pre></td></tr></table></figure><h3 id="2-2-配置开机自启动"><a href="#2-2-配置开机自启动" class="headerlink" title="2.2 配置开机自启动"></a>2.2 配置开机自启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /usr/lib/systemd/system/prometheus.service<br>[Unit]<br>Description=prometheus service<br> <br>[Service]<br>User=root<br>ExecStart=/opt/prometheus/prometheus --config.file=/opt/prometheus/prometheus.yml --storage.tsdb.path=/opt/prometheus/data<br> <br>TimeoutStopSec=10<br>Restart=on-failure<br>RestartSec=5<br> <br>[Install]<br>WantedBy=multi-user.target<br>systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> prometheus<br></code></pre></td></tr></table></figure><h3 id="2-3-启动服务"><a href="#2-3-启动服务" class="headerlink" title="2.3 启动服务"></a>2.3 启动服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl start prometheus<br>systemctl status prometheus<br></code></pre></td></tr></table></figure><h3 id="2-4-验证"><a href="#2-4-验证" class="headerlink" title="2.4 验证"></a>2.4 验证</h3><p>浏览器打开IP:9090端口即可打开 prometheus 自带的监控页面：</p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/prometheus-native-ui.png"><img src="/../images/prometheus-native-ui.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><h2 id="3-安装Grafana"><a href="#3-安装Grafana" class="headerlink" title="3 安装Grafana"></a>3 安装Grafana</h2><p>普罗米修斯默认的页面可能没有那么直观，我们可以安装grafana使监控看起来更直观。</p><h3 id="3-1-配置清华大学的yum源"><a href="#3-1-配置清华大学的yum源" class="headerlink" title="3.1 配置清华大学的yum源"></a>3.1 配置清华大学的yum源</h3><p>打开浏览器输入地址：<code>https://mirror.tuna.tsinghua.edu.cn/help/grafana/</code>，复制CentOS&#x2F;Redhat用户部分：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/yum.repos.d/grafana.repo<br>[grafana]<br>name=grafana<br>baseurl=https://mirrors.tuna.tsinghua.edu.cn/grafana/yum/rpm<br>repo_gpgcheck=0<br>enabled=1<br>gpgcheck=0<br>yum makecache<br></code></pre></td></tr></table></figure><h3 id="3-2-安装Grafana"><a href="#3-2-安装Grafana" class="headerlink" title="3.2 安装Grafana"></a>3.2 安装Grafana</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install grafana -y<br></code></pre></td></tr></table></figure><h3 id="3-3-启动服务"><a href="#3-3-启动服务" class="headerlink" title="3.3 启动服务"></a>3.3 启动服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> grafana-server<br>systemctl start grafana-server<br></code></pre></td></tr></table></figure><h3 id="3-4-访问Grafana"><a href="#3-4-访问Grafana" class="headerlink" title="3.4 访问Grafana"></a>3.4 访问Grafana</h3><p>浏览器访问IP:3000端口，即可打开grafana页面，默认用户名密码都是admin，初次登录会要求修改默认的登录密码：</p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/grafana-login.png"><img src="/../images/grafana-login.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/grafana-login-pass.png"><img src="/../images/grafana-login-pass.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/grafana-login-home.png"><img src="/../images/grafana-login-home.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><h3 id="3-5-添加Prometheus数据源"><a href="#3-5-添加Prometheus数据源" class="headerlink" title="3.5 添加Prometheus数据源"></a>3.5 添加Prometheus数据源</h3><p>点击主界面的“Add your first data source”并选择Prometheus：</p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/grafana-add-first-source.png"><img src="/../images/grafana-add-first-source.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/grafana-select.png"><img src="/../images/grafana-select.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p>Dashboards页面选择“Prometheus 2.0 Stats”进行Import：</p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/prometheus-dashboard.png"><img src="/../images/prometheus-dashboard.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p>Settings页面填写普罗米修斯地址并保存：</p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/prometheus-settings.png"><img src="/../images/prometheus-settings.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p>切换到我们刚才添加的“Prometheus 2.0 Stats”即可看到整个监控页面：</p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/prometheus-dashboard-2.0.png"><img src="/../images/prometheus-dashboard-2.0.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><h2 id="4-一些常用监控示例"><a href="#4-一些常用监控示例" class="headerlink" title="4 一些常用监控示例"></a>4 一些常用监控示例</h2><h3 id="4-1-监控Linux机器-node-exporter"><a href="#4-1-监控Linux机器-node-exporter" class="headerlink" title="4.1 监控Linux机器(node_exporter)"></a>4.1 监控Linux机器(node_exporter)</h3><ul><li>下载地址：</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/prometheus/</span>node_exporter<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/v1.1.1/</span>node_exporter-<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span>.linux-amd64.tar.gz<br></code></pre></td></tr></table></figure><ul><li>被监控的机器安装node_exporter：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">tar zxf node_exporter-1.1.1.linux-amd64.tar.gz -C /opt<br><span class="hljs-built_in">mv</span> /opt/node_exporter-1.1.1.linux-amd64 /opt/node_exporter<br></code></pre></td></tr></table></figure><ul><li>启动服务：</li></ul><p>配置开机自启动：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /usr/lib/systemd/system/node_exporter.service<br>[Unit]<br>Description=node_exporter service<br> <br>[Service]<br>User=root<br>ExecStart=/opt/node_exporter/node_exporter<br> <br>TimeoutStopSec=10<br>Restart=on-failure<br>RestartSec=5<br> <br>[Install]<br>WantedBy=multi-user.target<br>systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> node_exporter<br></code></pre></td></tr></table></figure><p>启动服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl start node_exporter<br>systemctl status node_exporter<br></code></pre></td></tr></table></figure><ul><li>Prometheus配置文件添加监控项：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /opt/prometheus/prometheus.yml<br>  - job_name: <span class="hljs-string">&#x27;linux-node&#x27;</span><br>    static_configs:<br>    - targets: [<span class="hljs-string">&#x27;192.168.0.112:9100&#x27;</span>]<br>      labels:<br>        instance: linux-node1<br></code></pre></td></tr></table></figure><p>重启Prometheus：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl restart prometheus<br></code></pre></td></tr></table></figure><ul><li>grafana导入画好的dashboard：</li></ul><p>Json文件下载地址：<a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/node-exporter_rev5.json">node-exporter_rev5.json</a></p><p>或者使用ID导入的方式：<code>8919</code></p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/ne-manage.png"><img src="/../images/ne-manage.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/ne-import.png"><img src="/../images/ne-import.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/ne-upload.png"><img src="/../images/ne-upload.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p>修改名字，选择我们前文创建好的数据源，点击导入即可：</p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/ne-rename1.png"><img src="/../images/ne-rename1.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p>下面这个提示是grafana缺少相关显示需要用到的插件piechart，grafana的默认插件目录是&#x2F;var&#x2F;lib&#x2F;grafana&#x2F;plugins，可以将下载好的插件解压到这个目录，重启grafana即可</p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/ne-no-plugin.png"><img src="/../images/ne-no-plugin.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p>插件下载地址：<a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/grafana-piechart-panel-5f249d5.zip">grafana-piechart-panel</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">unzip -q grafana-piechart-panel-5f249d5.zip -d /var/lib/grafana/plugins/<br>systemctl restart grafana-server<br></code></pre></td></tr></table></figure><p>查看已安装插件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">/usr/sbin/grafana-cli plugins <span class="hljs-built_in">ls</span><br>installed plugins:<br>grafana-piechart-panel @ 1.3.3<br></code></pre></td></tr></table></figure><p>Tips：安装插件还有另外一种命令行方式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">grafana-cli plugins install grafana-piechart-panel<br>grafana-cli plugins install digiapulssi-breadcrumb-panel<br>grafana-cli plugins install grafana-polystat-panel<br> <br>systemctl restart grafana-server<br></code></pre></td></tr></table></figure><p>再刷新grafana页面，即可看到我们刚才设置好的node监控：</p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/ne-success.png"><img src="/../images/ne-success.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><h3 id="4-2-监控MySQL-mysqld-exporter"><a href="#4-2-监控MySQL-mysqld-exporter" class="headerlink" title="4.2 监控MySQL(mysqld_exporter)"></a>4.2 监控MySQL(mysqld_exporter)</h3><ul><li>在被监控服务器创建监控用户：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">GRANT REPLICATION CLIENT, PROCESS ON *.* TO <span class="hljs-string">&#x27;mysqld_exporter&#x27;</span>@<span class="hljs-string">&#x27;127.0.0.1&#x27;</span> identified by <span class="hljs-string">&#x27;mysqld_exporter&#x27;</span>;<br>GRANT SELECT ON performance_schema.* TO <span class="hljs-string">&#x27;mysqld_exporter&#x27;</span>@<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>;<br>flush privileges;<br></code></pre></td></tr></table></figure><ul><li>下载地址：</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/prometheus/my</span>sqld_exporter<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/v0.12.1/my</span>sqld_exporter-<span class="hljs-number">0.12</span>.<span class="hljs-number">1</span>.linux-amd64.tar.gz<br></code></pre></td></tr></table></figure><ul><li>被监控的机器安装mysqld_exporter：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /opt<br>tar zxf mysqld_exporter-0.12.1.linux-amd64.tar.gz -C /opt<br><span class="hljs-built_in">mv</span> /opt/mysqld_exporter-0.12.1.linux-amd64 /opt/mysqld_exporter<br><span class="hljs-built_in">cd</span> /opt/mysqld_exporter<br></code></pre></td></tr></table></figure><ul><li>设置配置文件，user为数据库登录用户，password为这个用户的密码：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim .my.cnf<br> <br>[client]<br>host=127.0.0.1<br>port=3306<br>user=mysqld_exporter<br>password=mysqld_exporter<br></code></pre></td></tr></table></figure><ul><li>配置开机自启动并启动服务：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /usr/lib/systemd/system/mysqld_exporter.service<br>[Unit]<br>Description=mysqld_exporter service<br> <br>[Service]<br>User=root<br>ExecStart=/opt/mysqld_exporter/mysqld_exporter --config.my-cnf=/opt/mysqld_exporter/.my.cnf<br> <br>TimeoutStopSec=10<br>Restart=on-failure<br>RestartSec=5<br> <br>[Install]<br>WantedBy=multi-user.target<br>systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> mysqld_exporter<br>systemctl start mysqld_exporter<br>systemctl status mysqld_exporter<br></code></pre></td></tr></table></figure><ul><li>prometheus配置文件中加入mysql监控并重启：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /opt/monitor/prometheus/prometheus.yml<br>  - job_name: <span class="hljs-string">&#x27;mysqld-node&#x27;</span><br>    static_configs:<br>    - targets: [<span class="hljs-string">&#x27;192.168.1.235:9104&#x27;</span>]<br>      labels:<br>        instance: mysqld-node1<br></code></pre></td></tr></table></figure><p>重启服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl restart prometheus<br></code></pre></td></tr></table></figure><p>模板Json文件下载地址：<a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/mysql_rev1.json">mysql_rev1.json</a></p><ul><li>导入已经画好的dashboard，数据源选择刚刚创建好的 <code>prometheus</code> 数据源即可：</li></ul><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/mysqld-6.png"><img src="/../images/mysqld-6.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/mysqld-7.png"><img src="/../images/mysqld-7.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/mysqld-8.png"><img src="/../images/mysqld-8.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p><a target="_blank" rel="noopener" href="https://picture-bed-iuskye.oss-cn-beijing.aliyuncs.com/prometheus/mysqld-9.png"><img src="/../images/mysqld-9.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p>Tips: 导入模板那里也可以采用输入grafana id的方式进行import，这里我们不用上传该json文件，而是输入id <code>7362</code>，然后点击 <code>load</code> 按钮即可：</p><p><a target="_blank" rel="noopener" href="https://oss.iuskye.com/article/2021-03-30/grafana-import-id.png"><img src="/../images/grafana-import-id.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p><a target="_blank" rel="noopener" href="https://oss.iuskye.com/article/2021-03-30/grafana-import-rename.png"><img src="/../images/grafana-import-rename.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p><a target="_blank" rel="noopener" href="https://oss.iuskye.com/article/2021-03-30/grafana-import-mysql.png"><img src="/../images/grafana-import-mysql.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><h3 id="4-3-监控Redis-redis-exporter"><a href="#4-3-监控Redis-redis-exporter" class="headerlink" title="4.3 监控Redis(redis_exporter)"></a>4.3 监控Redis(redis_exporter)</h3><ul><li>下载地址：</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/oliver006/</span>redis_exporter<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/v1.20.0/</span>redis_exporter-v1.<span class="hljs-number">20.0</span>.linux-amd64.tar.gz<br></code></pre></td></tr></table></figure><ul><li>安装redis_exporter：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /opt/redis_exporter<br>tar zxf redis_exporter-v1.20.0.linux-amd64.tar.gz -C /opt/redis_exporter<br></code></pre></td></tr></table></figure><ul><li>配置开机自启动并启动服务：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /usr/lib/systemd/system/redis_exporter.service<br>[Unit]<br>Description=redis_exporter service<br> <br>[Service]<br>User=root<br>ExecStart=/opt/redis_exporter/redis_exporter -redis.addr redis://192.168.1.235:6379 -redis.password 123456<br> <br>TimeoutStopSec=10<br>Restart=on-failure<br>RestartSec=5<br> <br>[Install]<br>WantedBy=multi-user.target<br>systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> redis_exporter<br>systemctl start redis_exporter<br>systemctl status redis_exporter<br></code></pre></td></tr></table></figure><ul><li>prometheus配置文件中加入redis监控并重启：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /opt/prometheus/prometheus.yml<br>  - job_name: <span class="hljs-string">&#x27;redis-node&#x27;</span><br>    static_configs:<br>    - targets: [<span class="hljs-string">&#x27;192.168.0.116:9121&#x27;</span>]<br>      labels:<br>        instance: redis-node1<br></code></pre></td></tr></table></figure><p>重启服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl restart prometheus<br></code></pre></td></tr></table></figure><ul><li>grafana导入画好的dashboard：</li></ul><p>Grafana ID: 4074 或者 14091</p><p><a target="_blank" rel="noopener" href="https://oss.iuskye.com/article/2021-03-30/grafana-redis-dash.png"><img src="/../images/grafana-redis-dash.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><h3 id="4-4-监控Elasticsearch-elasticsearch-exporter"><a href="#4-4-监控Elasticsearch-elasticsearch-exporter" class="headerlink" title="4.4 监控Elasticsearch(elasticsearch_exporter)"></a>4.4 监控Elasticsearch(elasticsearch_exporter)</h3><ul><li>下载地址：</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/justwatchcom/</span>elasticsearch_exporter<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/v1.1.0/</span>elasticsearch_exporter-<span class="hljs-number">1.1</span>.<span class="hljs-number">0</span>.linux-amd64.tar.gz<br></code></pre></td></tr></table></figure><ul><li>安装elasticsearch_exporter：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /opt<br>tar zxf elasticsearch_exporter-1.1.0.linux-amd64.tar.gz -C /opt/<br><span class="hljs-built_in">mv</span> /opt/elasticsearch_exporter-1.1.0.linux-amd64 /opt/elasticsearch_exporter<br></code></pre></td></tr></table></figure><ul><li>配置开机自启动并启动服务：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /usr/lib/systemd/system/elasticsearch_exporter.service<br>[Unit]<br>Description=elasticsearch_exporter service<br> <br>[Service]<br>User=root<br>ExecStart=/opt/elasticsearch_exporter/elasticsearch_exporter --es.uri=http://elastic:123456@127.0.0.1:9200<br> <br>TimeoutStopSec=10<br>Restart=on-failure<br>RestartSec=5<br> <br>[Install]<br>WantedBy=multi-user.target<br>vim /usr/lib/systemd/system/elasticsearch_exporter.service<br>systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> elasticsearch_exporter<br>systemctl start elasticsearch_exporter<br>systemctl status elasticsearch_exporter<br></code></pre></td></tr></table></figure><ul><li>prometheus配置文件中加入elasticsearch监控并重启：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /opt/prometheus/prometheus.yml<br>  - job_name: <span class="hljs-string">&#x27;elasticsearch-node&#x27;</span><br>    static_configs:<br>    - targets: [<span class="hljs-string">&#x27;192.168.0.116:9114&#x27;</span>]<br>      labels:<br>        instance: elasticsearch-node1<br></code></pre></td></tr></table></figure><ul><li>这里提供一段通过公网https协议进行监控的配置项：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">- job_name: <span class="hljs-string">&#x27;es-node&#x27;</span><br>  static_configs:<br>  - targets: [<span class="hljs-string">&#x27;mmbapoc.zhizhangyi.com:9070&#x27;</span>]<br>    labels:<br>      instance: es-node1<br>  scheme: https<br>  metrics_path: /es/node1<br></code></pre></td></tr></table></figure><p>解释一下：scheme指定pull数据的协议为https，metrics_path指定Exporter机器上Nginx反向代理匹配路径，见下文。</p><ul><li>Nginx反向代理配置：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">location /es/node1 &#123;<br>    proxy_pass   http://127.0.0.1:9114/metrics;<br>    proxy_set_header Host <span class="hljs-variable">$http_host</span>;<br>    proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>    proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>    proxy_set_header X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>解释一下，该Nginx部署在内网中，Prometheus通过公网请求Nginx，然后由Nginx反向代理到Exporter服务器。</p><ul><li>重启服务：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl restart prometheus<br></code></pre></td></tr></table></figure><ul><li>grafana导入画好的dashboard：</li></ul><p>Grafana ID: 2322</p><p><a target="_blank" rel="noopener" href="https://oss.iuskye.com/article/2021-03-30/grafana-es-dash.png"><img src="/../images/grafana-es-dash.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><h3 id="4-5-监控Rabbitmq-rabbitmq-exporter"><a href="#4-5-监控Rabbitmq-rabbitmq-exporter" class="headerlink" title="4.5 监控Rabbitmq(rabbitmq_exporter)"></a>4.5 监控Rabbitmq(rabbitmq_exporter)</h3><ul><li>下载地址：</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/kbudde/</span>rabbitmq_exporter<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/v1.0.0-RC8/</span>rabbitmq_exporter-<span class="hljs-number">1.0</span>.<span class="hljs-number">0</span>-RC8.linux-amd64.tar.gz<br></code></pre></td></tr></table></figure><ul><li>安装rabbitmq_exporter：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /opt<br>tar zxf rabbitmq_exporter-1.0.0-RC8.linux-amd64.tar.gz -C /opt<br><span class="hljs-built_in">mv</span> /opt/rabbitmq_exporter-1.0.0-RC8.linux-amd64 /opt/rabbitmq_exporter<br></code></pre></td></tr></table></figure><ul><li>配置开机自启动并启动服务：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /usr/lib/systemd/system/rabbitmq_exporter.service<br>[Unit]<br>Description=rabbitmq_exporter service<br> <br>[Service]<br>User=root<br>ExecStart=/opt/rabbitmq_exporter/rabbitmq_exporter -config-file /opt/rabbitmq_exporter/config.json<br> <br>TimeoutStopSec=10<br>Restart=on-failure<br>RestartSec=5<br> <br>[Install]<br>WantedBy=multi-user.target<br>vim /opt/rabbitmq_exporter/config.json<br> <br>&#123;<br>    <span class="hljs-string">&quot;rabbit_url&quot;</span>: <span class="hljs-string">&quot;http://127.0.0.1:15672&quot;</span>,<br>    <span class="hljs-string">&quot;rabbit_user&quot;</span>: <span class="hljs-string">&quot;rabbitadmin&quot;</span>,<br>    <span class="hljs-string">&quot;rabbit_pass&quot;</span>: <span class="hljs-string">&quot;123456&quot;</span>,<br>    <span class="hljs-string">&quot;publish_port&quot;</span>: <span class="hljs-string">&quot;9119&quot;</span>,<br>    <span class="hljs-string">&quot;publish_addr&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;output_format&quot;</span>: <span class="hljs-string">&quot;TTY&quot;</span>,<br>    <span class="hljs-string">&quot;ca_file&quot;</span>: <span class="hljs-string">&quot;ca.pem&quot;</span>,<br>    <span class="hljs-string">&quot;cert_file&quot;</span>: <span class="hljs-string">&quot;client-cert.pem&quot;</span>,<br>    <span class="hljs-string">&quot;key_file&quot;</span>: <span class="hljs-string">&quot;client-key.pem&quot;</span>,<br>    <span class="hljs-string">&quot;insecure_skip_verify&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;exlude_metrics&quot;</span>: [],<br>    <span class="hljs-string">&quot;include_queues&quot;</span>: <span class="hljs-string">&quot;.*&quot;</span>,<br>    <span class="hljs-string">&quot;skip_queues&quot;</span>: <span class="hljs-string">&quot;^$&quot;</span>,<br>    <span class="hljs-string">&quot;skip_vhost&quot;</span>: <span class="hljs-string">&quot;^$&quot;</span>,<br>    <span class="hljs-string">&quot;include_vhost&quot;</span>: <span class="hljs-string">&quot;.*&quot;</span>,<br>    <span class="hljs-string">&quot;rabbit_capabilities&quot;</span>: <span class="hljs-string">&quot;no_sort,bert&quot;</span>,<br>    <span class="hljs-string">&quot;enabled_exporters&quot;</span>: [<br>            <span class="hljs-string">&quot;exchange&quot;</span>,<br>            <span class="hljs-string">&quot;node&quot;</span>,<br>            <span class="hljs-string">&quot;overview&quot;</span>,<br>            <span class="hljs-string">&quot;queue&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;timeout&quot;</span>: 30,<br>    <span class="hljs-string">&quot;max_queues&quot;</span>: 0<br>&#125;<br>vim /usr/lib/systemd/system/rabbitmq_exporter.service<br>systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> rabbitmq_exporter<br>systemctl start rabbitmq_exporter<br>systemctl status rabbitmq_exporter<br></code></pre></td></tr></table></figure><ul><li>prometheus配置文件中加入rabbitmq监控并重启：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /opt/prometheus/prometheus.yml<br>  - job_name: <span class="hljs-string">&#x27;rabbitmq-node&#x27;</span><br>    static_configs:<br>    - targets: [<span class="hljs-string">&#x27;192.168.0.116:9119&#x27;</span>]<br>      labels:<br>        instance: rabbitmq-node1<br></code></pre></td></tr></table></figure><ul><li>这里提供一段通过公网https协议进行监控的配置项：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">- job_name: <span class="hljs-string">&#x27;rabbitmq-node&#x27;</span><br>  static_configs:<br>  - targets: [<span class="hljs-string">&#x27;mmbapoc.zhizhangyi.com:9070&#x27;</span>]<br>    labels:<br>      instance: rabbitmq-node1<br>  scheme: https<br>  metrics_path: /rabbitmq/node1<br></code></pre></td></tr></table></figure><p>解释一下：scheme指定pull数据的协议为https，metrics_path指定Exporter机器上Nginx反向代理匹配路径，见下文。</p><ul><li>Nginx反向代理配置：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">location /rabbitmq/node1 &#123;<br>    proxy_pass   http://127.0.0.1:9119/metrics;<br>    proxy_set_header Host <span class="hljs-variable">$http_host</span>;<br>    proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>    proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>    proxy_set_header X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>解释一下，该Nginx部署在内网中，Prometheus通过公网请求Nginx，然后由Nginx反向代理到Exporter服务器。</p><ul><li>重启服务：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl restart prometheus<br></code></pre></td></tr></table></figure><ul><li>grafana导入画好的dashboard：</li></ul><p>Grafana ID: 10120</p><p><a target="_blank" rel="noopener" href="https://cdn.iuskye.com/article/2021-03-30/grafana-mq-dash1.png"><img src="/../images/grafana-mq-dash1.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><p><a target="_blank" rel="noopener" href="https://cdn.iuskye.com/article/2021-03-30/grafana-mq-dash2.png"><img src="/../images/grafana-mq-dash2.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><h3 id="4-6-监控JMX-jmx-exporter"><a href="#4-6-监控JMX-jmx-exporter" class="headerlink" title="4.6 监控JMX(jmx_exporter)"></a>4.6 监控JMX(jmx_exporter)</h3><p>以下配置与业务联系紧密，不具有广泛参考性！</p><p><a target="_blank" rel="noopener" href="https://github.com/prometheus/jmx_exporter">源码地址</a> | <a target="_blank" rel="noopener" href="https://oss.iuskye.com/article/2021-03-31/jmx_prometheus_javaagent-0.15.0.jar">编译后下载地址</a></p><p>将上述jar文件上传至项目目录下，我们以 <code>mmba-service</code> 为例，将jar包存放在 <code>mmba-service/classes/jmx_prometheus_javaagent-0.15.0.jar</code>。</p><p>修改 <code>mmba-service</code> 服务的启动参数：</p><ul><li>原来：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">nohup</span> java -Dconfig.cluster=<span class="hljs-variable">$&#123;ZOOKEEPER_URL&#125;</span> -Xmx1G -Xms1G -classpath \<br>        ./:../lib/* com.uusafe.analyze.mmba.service.App &gt;/dev/null 2&gt;&amp;1 &amp;<br></code></pre></td></tr></table></figure><ul><li>修改后：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">nohup</span> java -javaagent:./jmx_prometheus_javaagent-0.15.0.jar=9501:./config_jmx.yml \<br>    -Dcom.sun.management.jmxremote.ssl=<span class="hljs-literal">false</span> \<br>    -Dcom.sun.management.jmxremote.authenticate=<span class="hljs-literal">false</span> \<br>    -Dcom.sun.management.jmxremote.port=5555 \<br>    -Dconfig.cluster=<span class="hljs-variable">$&#123;ZOOKEEPER_URL&#125;</span> \<br>    -Xmx1G -Xms1G \<br>    -classpath ./:../lib/* com.uusafe.analyze.mmba.service.App &gt;/dev/null 2&gt;&amp;1 &amp;<br></code></pre></td></tr></table></figure><p>主要区别是：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">-javaagent:./jmx_prometheus_javaagent-0.15.0.jar=9501:./config_jmx.yml \<br>    -Dcom.sun.management.jmxremote.ssl=<span class="hljs-literal">false</span> \<br>    -Dcom.sun.management.jmxremote.authenticate=<span class="hljs-literal">false</span> \<br>    -Dcom.sun.management.jmxremote.port=5555 \<br></code></pre></td></tr></table></figure><p><code>config_jmx.yml</code> 配置文件内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">---<br>startDelaySeconds: 0<br>hostPort: 127.0.0.1:5555<br>ssl: <span class="hljs-literal">false</span><br>lowercaseOutputName: <span class="hljs-literal">false</span><br>lowercaseOutputLabelNames: <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><p>注意端口要一致，启动服务Java服务。</p><p>配置Nginx代理：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">location /java/mmba/service &#123;<br>    proxy_pass   http://127.0.0.1:9501/metrics;<br>      proxy_set_header Host <span class="hljs-variable">$http_host</span>;<br>      proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>      proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>      proxy_set_header X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>这个路径是自定义的路径，要与下文中 <code>prometheus</code> 的配置文件中 <code>metrics_path</code> 值匹配。</p><p>重载Nginx：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/opt/nginx/sbin/nginx -s reload<br></code></pre></td></tr></table></figure><p>修改 <code>prometheus</code> 配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo vim prometheus.yml<br>  - job_name: <span class="hljs-string">&#x27;mmba-service&#x27;</span><br>    static_configs:<br>    - targets: [<span class="hljs-string">&#x27;mmba116.test.com:9070&#x27;</span>]<br>      labels:<br>        instance: mmba-service<br>    scheme: https<br>    metrics_path: /java/mmba/service<br></code></pre></td></tr></table></figure><p>重启 <code>prometheus</code> 服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo systemctl restart prometheus<br></code></pre></td></tr></table></figure><p>登录grafana面板配置 <code>dashboard</code>：</p><p>导入模板那里输入 <code>grafana id</code> 为 <code>10519</code> 。</p><p>示例截图：</p><p><a target="_blank" rel="noopener" href="https://oss.iuskye.com/article/2021-03-31/jmx-dash.png"><img src="/../images/jmx-dash.png" srcset="/img/loading.gif" lazyload alt="img"></a></p><h2 id="5-常用网站"><a href="#5-常用网站" class="headerlink" title="5 常用网站"></a>5 常用网站</h2><ul><li>prometheus download: <code>https://prometheus.io/download/</code></li><li>prometheus exporter: <code>https://prometheus.io/docs/instrumenting/exporters/</code></li><li>grafana dashboard: <code>https://grafana.com/dashboards</code></li><li>grafana plugins: <code>https://grafana.com/plugins</code></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/linux/" class="category-chain-item">linux</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/Prometheus/">#Prometheus</a></div></div><div class="license-box my-3"><div class="license-title"><div>Prometheus Tutorial</div><div>https://git.msft.vip/2022/12/23-prometheus-Tutorial/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Jas0n0ss</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2022年12月23日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2024年8月9日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i> </span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/"><span class="hint--top hint--rounded" aria-label="ND - 禁止演绎"><i class="iconfont icon-nd"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2022/12/23-Redis-tutorial/" title="Redis tutorial"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Redis tutorial</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2022/12/23-zabbix-Tutorial/" title="zabbix Tutorial"><span class="hidden-mobile">zabbix Tutorial</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script>Fluid.utils.loadComments("#disqus_thread",(function(){Fluid.utils.createCssLink("https://cdn.staticfile.org/disqusjs/1.3.0/disqusjs.css"),Fluid.utils.createScript("https://cdn.staticfile.org/disqusjs/1.3.0/disqus.js",(function(){new DisqusJS({shortname:"fluid",apikey:""})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></div></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><script>Fluid.utils.createScript("https://cdn.staticfile.org/mermaid/8.14.0/mermaid.min.js",(function(){mermaid.initialize({theme:"default"}),Fluid.events.registerRefreshCallback((function(){"mermaid"in window&&mermaid.init()}))}))</script><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Copyrights</span></a> <i class="iconfont icon-love"></i> <a href="https://git.msft.vip" target="_blank" rel="nofollow noopener"><span>Jas0n0ss</span></a></div></div></footer><script src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://cdn.staticfile.org/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://cdn.staticfile.org/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://cdn.staticfile.org/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://cdn.staticfile.org/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>